{% extends 'base.html' %}
{% block title %}Antigravity Studio | Premium Video AI{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Bangers&family=Luckiest+Guy&family=Roboto:wght@700;900&family=Oswald:wght@700&family=Permanent+Marker&family=Righteous&family=Kaushan+Script&family=Anton&family=Archivo+Black&family=Bebas+Neue&family=Fredoka+One&family=Passion+One&family=Titan+One&family=Montserrat:wght@700;900&family=Lobster&family=Poppins:wght@600;800&display=swap"
    rel="stylesheet">
{% endblock %}

{% block content %}
{% include '_aspect_modal.html' %}
{% include '_settings_panel.html' %}
<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="logo-area">
        <div class="logo-icon"><i class="fas fa-bolt"></i></div>
        <div class="logo-text">AG Studio</div>
    </div>
    <nav class="nav-menu">
        <a href="#" class="nav-item active" onclick="switchView('dashboard')">
            <i class="fas fa-th-large nav-icon"></i> Dashboard
        </a>
        <a href="#" class="nav-item" onclick="switchView('projects')">
            <i class="fas fa-folder nav-icon"></i> Projects
        </a>
        <a href="#" class="nav-item" onclick="switchView('jobs')">
            <i class="fas fa-tasks nav-icon"></i> Job Queue
        </a>
        <a href="#" class="nav-item" onclick="switchView('browser')">
            <i class="fas fa-globe-americas nav-icon"></i> Browser
        </a>
        {% if user_role == 'admin' %}
        <a href="#" class="nav-item" onclick="switchView('storage')">
            <i class="fas fa-hdd nav-icon"></i> Storage
        </a>
        <a href="#" class="nav-item" onclick="switchView('users')">
            <i class="fas fa-user-shield nav-icon"></i> Users
        </a>
        {% endif %}
    </nav>
    <div class="sidebar-footer">
        <button id="pwaUpdateBtn" class="nav-item"
            style="border:none; background:rgba(99, 102, 241, 0.1); width:calc(100% - 24px); margin: 0 12px 8px; border-radius: 8px; cursor:pointer; color:var(--primary); display:flex; align-items:center; gap:12px; padding: 10px 16px; font-size:0.9rem; transition: 0.2s;"
            onclick="updatePWA()">
            <i class="fas fa-sync-alt nav-icon"></i> <span id="pwaBtnText">Check Updates</span>
        </button>
        <a href="/logout" class="nav-item" style="color: var(--danger);">
            <i class="fas fa-sign-out-alt nav-icon"></i> Logout
        </a>
    </div>
</aside>

<!-- Main Content -->
<main class="main-content">
    <!-- Header -->
    <header class="header">
        <div style="display:flex; align-items:center; gap:16px;">
            <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h1 class="page-title" id="pageTitle">Dashboard</h1>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
            <button class="btn btn-secondary" onclick="openSettingsPanel()" title="Cookie & Proxy Settings"
                style="padding:8px 16px; font-size:0.9rem;">
                <i class="fas fa-cog"></i> Settings
            </button>
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
        </div>
    </header>

    <!-- VIEWS -->

    <!-- 1. Dashboard View -->
    <div id="view-dashboard" class="view-section active">
        <!-- Stats Row -->
        <div class="grid-cols-4 mb-8" style="margin-bottom: 32px;">
            <div class="card stats-card">
                <div class="stat-value" id="stat-active-jobs">0</div>
                <div class="stat-label">Active Jobs</div>
                <i class="fas fa-play-circle stat-icon"></i>
            </div>
            <div class="card stats-card">
                <div class="stat-value" id="stat-queue-size">0</div>
                <div class="stat-label">In Queue</div>
                <i class="fas fa-clock stat-icon"></i>
            </div>
            <div class="card stats-card">
                <div class="stat-value" id="stat-completed-today">0</div>
                <div class="stat-label">Completed Today</div>
                <i class="fas fa-check-circle stat-icon"></i>
            </div>
            <div class="card stats-card"
                style="background: linear-gradient(135deg, var(--primary), #4338ca); color:white;">
                <div class="stat-value" style="color:white;">Pro</div>
                <div class="stat-label" style="color:rgba(255,255,255,0.8);">Plan Status</div>
                <i class="fas fa-crown stat-icon" style="opacity:0.4;"></i>
            </div>
        </div>

        <div class="grid-cols-2">
            <div class="card">
                <h3 style="margin-bottom:16px;">System Activity</h3>
                <div id="dashboard-activity-list" class="list-group">
                    <div style="padding:20px; text-align:center; color:var(--text-muted);">Loading activity...</div>
                </div>
            </div>
            <div class="card">
                <h3 style="margin-bottom:16px;">Quick Actions</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                    <button class="btn btn-secondary"
                        onclick="switchView('projects'); document.getElementById('newProjectName').focus();">
                        <i class="fas fa-plus"></i> New Project
                    </button>
                    <button class="btn btn-secondary" onclick="switchView('projects');">
                        <i class="fas fa-upload"></i> Upload Video
                    </button>
                    <button class="btn btn-secondary" onclick="testNotification()">
                        <i class="fas fa-bell"></i> Test Alerts
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Projects View -->
    <div id="view-projects" class="view-section">
        <div class="card" style="margin-bottom:24px; display:flex; gap:16px; align-items:center;">
            <input type="text" id="newProjectName" class="input-field" placeholder="Project Name..."
                style="max-width:300px;">
            <button class="btn btn-primary" onclick="createProject()">Create Project</button>
            <div style="margin-left:auto;">
                <button class="btn btn-secondary" onclick="refreshProjects()"><i class="fas fa-sync"></i>
                    Refresh</button>
            </div>
        </div>

        <div id="projects-grid" class="grid-cols-4">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- 3. Project Detail View -->
    <div id="view-project-detail" class="view-section">
        <button class="btn btn-secondary" style="margin-bottom:20px;" onclick="switchView('projects')">
            <i class="fas fa-arrow-left"></i> Back to Projects
        </button>

        <!-- Project Controls -->
        <div class="card" style="margin-bottom:24px;">
            <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
                <div style="flex:1;">
                    <h2 id="current-project-title" style="font-size:1.5rem; font-weight:700;">Project Name</h2>
                    <div style="color:var(--text-muted); font-size:0.9rem;" id="current-project-id">ID: 123</div>
                </div>
                <!-- Upload/Download Bar -->
                <div style="display:flex; gap:12px; align-items:center;">
                    <select id="downloadRes" class="input-field" style="width:100px;">
                        <option value="720">720p</option>
                        <option value="1080">1080p</option>
                        <option value="max">Source Quality</option>
                    </select>
                    <input type="text" id="urlInput" class="input-field"
                        placeholder="Paste Video URL (YouTube/TikTok)..." style="width:280px;">
                    <button class="btn btn-primary" id="downloadBtn" onclick="startDownload()">
                        <i class="fas fa-cloud-download-alt"></i> Download
                    </button>
                    <input type="file" id="fileUpload" style="display:none;" accept="video/*"
                        onchange="handleFileUpload(this)">
                    <button class="btn btn-secondary" onclick="document.getElementById('fileUpload').click()">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                    <button class="btn btn-secondary" onclick="openServerImportModal()"
                        style="border-color:var(--primary); color:var(--primary);">
                        <i class="fas fa-server"></i> Safe Import
                    </button>
                </div>
            </div>
        </div>

        <!-- Two Column Layout for Editor -->
        <div style="display:grid; grid-template-columns: 350px 1fr; gap:24px;">
            <!-- Left: Video List -->
            <div class="card" style="height:calc(100vh - 250px); overflow:hidden; display:flex; flex-direction:column;">
                <div
                    style="padding-bottom:12px; border-bottom:1px solid var(--border-color); margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="font-size:1.1rem;">Videos</h3>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-secondary"
                            style="padding:4px 10px; font-size:0.75rem; background:#000; color:#fff;"
                            onclick="openReelView()">
                            <i class="fas fa-mobile-alt"></i> Reel Mode
                        </button>
                        <button id="bulkDeleteBtn" class="btn btn-danger"
                            style="padding:4px 10px; font-size:0.75rem; display:none;" onclick="confirmBulkDelete()">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button class="btn btn-secondary" style="padding:4px 8px; font-size:0.8rem;"
                            onclick="loadVideos(currentProjectId)"><i class="fas fa-sync"></i></button>
                    </div>
                </div>
                <div id="videoListContainer" style="overflow-y:auto; flex:1;">
                    <ul id="videoList" style="list-style:none;"></ul>
                </div>
            </div>

            <!-- Right: Preview & Edit -->
            <div>
                <!-- Video Player Card -->
                <div id="videoContainer" class="card" style="display:none; text-align:center;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <h3 id="videoTitle" style="text-align:left;">Video Title</h3>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary" onclick="toggleSplitMenu()">
                                <i class="fas fa-cut"></i> Split
                            </button>
                            <div id="splitMenu"
                                style="display:none; position:absolute; right:40px; margin-top:45px; background:white; border-radius:8px; box-shadow:var(--shadow-lg); z-index:100; min-width:180px; padding:8px; border:1px solid var(--border-color);">
                                <button class="btn btn-secondary" style="width:100%; border:none; text-align:left;"
                                    onclick="showSplitSettings('ai')">AI Scene Detection</button>
                                <button class="btn btn-secondary" style="width:100%; border:none; text-align:left;"
                                    onclick="showSplitSettings('fixed')">Fixed Interval</button>
                                <button class="btn btn-secondary" style="width:100%; border:none; text-align:left;"
                                    onclick="showSplitSettings('trim')">Manual Trim</button>
                            </div>

                            <div style="display:flex; gap:4px;">
                                <select id="captionLevel" class="input-field"
                                    style="width:100px; padding:4px 8px; font-size:0.75rem;">
                                    <option value="sentence">Sentence</option>
                                    <option value="word">Word Level</option>
                                </select>
                                <button class="btn btn-secondary" onclick="runCaptioning()">
                                    <i class="fas fa-closed-captioning"></i> Caption
                                </button>
                            </div>
                            <button class="btn btn-danger" onclick="makeVertical()" title="Make Vertical (9:16)">
                                <i class="fas fa-mobile-alt"></i> Vertical
                            </button>
                            <button class="btn btn-danger" onclick="deleteCurrentVideo()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div style="position:relative; width:100%; max-width:600px; margin:0 auto;">
                        <video id="videoPlayer" controls playsinline preload="auto"
                            style="width:100%; border-radius:var(--radius-sm); border:1px solid #000; background:black;">
                            <source id="videoSource" type="video/mp4">
                        </video>
                    </div>

                    <!-- Split Settings Panel (Hidden by default) -->
                    <div id="splitSettings"
                        style="display:none; margin-top:20px; text-align:left; background:#f8fafc; padding:16px; border-radius:var(--radius-sm);">
                        <h4>Split Settings</h4>

                        <div id="sceneDetectOptions" style="display:none; margin-top:10px;">
                            <label>Min Length (s): <input type="number" id="minSceneLen" value="2" class="input-field"
                                    style="width:80px; display:inline-block;"></label>
                            <label>Sensitivity: <input type="range" id="splitThreshold" min="1" max="100"
                                    value="3"></label>
                            <button class="btn btn-primary" onclick="confirmSplit()">Start AI Split</button>
                        </div>
                        <div id="fixedSplitOptions" style="display:none; margin-top:10px;">
                            <label>Interval (s): <input type="number" id="splitInterval" value="30" class="input-field"
                                    style="width:80px; display:inline-block;"></label>
                            <button class="btn btn-primary" onclick="confirmFixedSplit()">Start Fixed Split</button>
                        </div>
                        <div id="trimOptions" style="display:none; margin-top:10px;">
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <input type="number" id="trimStart" placeholder="Start" class="input-field">
                                <button class="btn btn-secondary" onclick="setTrimTime('start')">Get Time</button>
                            </div>
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <input type="number" id="trimEnd" placeholder="End" class="input-field">
                                <button class="btn btn-secondary" onclick="setTrimTime('end')">Get Time</button>
                            </div>
                            <button class="btn btn-primary" onclick="confirmTrim()">Cut Segment</button>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div id="timelineContainer"
                        style="display:none; margin-top:20px; background:#1e293b; padding:15px; border-radius:var(--radius-sm);">
                        <div style="color:white; display:flex; justify-content:space-between;">
                            <span>TIMELINE</span>
                            <span id="timelineTime">00:00 / 00:00</span>
                        </div>
                        <div id="timelineTrack" class="progress-track"
                            style="margin:10px 0; height:40px; background:#334155; position:relative; cursor:crosshair;">
                            <div id="selectionOverlay"
                                style="position:absolute; top:0; height:100%; background:rgba(56, 189, 248, 0.3); border-left:1px solid #38bdf8; border-right:1px solid #38bdf8; width:0;">
                            </div>
                            <div id="playhead"
                                style="position:absolute; top:0; left:0; width:2px; height:100%; background:red;"></div>
                        </div>
                        <div style="display:flex; gap:10px; justify-content:center;">
                            <button class="btn btn-secondary" style="padding:4px 10px; font-size:0.8rem;"
                                onclick="setTimelineMarker('in')">Set IN (I)</button>
                            <button class="btn btn-secondary" style="padding:4px 10px; font-size:0.8rem;"
                                onclick="setTimelineMarker('out')">Set OUT (O)</button>
                            <button class="btn btn-primary" style="padding:4px 10px; font-size:0.8rem;"
                                onclick="confirmTrimFromTimeline()">Extract</button>
                        </div>
                    </div>

                    <div id="captionLinks" style="margin-top:20px; text-align:left;"></div>
                    <a id="downloadLink" class="btn btn-primary" style="margin-top:20px; display:inline-flex;">
                        <i class="fas fa-download"></i> Download Video
                    </a>

                </div>
            </div>
        </div>
    </div>

    <!-- 6. User Management View -->
    <div id="view-users" class="view-section">
        <div class="card" style="margin-bottom:24px;">
            <h3>Create New Passcode</h3>
            <div style="display:flex; gap:16px; margin-top:16px; align-items:flex-end;">
                <div style="flex:1;"><label
                        style="display:block; font-size:0.8rem; margin-bottom:8px;">Username/Owner</label><input
                        type="text" id="newUserUsername" class="input-field" placeholder="e.g. Creator_James"></div>
                <div style="flex:1;"><label
                        style="display:block; font-size:0.8rem; margin-bottom:8px;">Passcode/Key</label><input
                        type="text" id="newUserPasscode" class="input-field" placeholder="Secret Access Code"></div>
                <button class="btn btn-primary" onclick="adminCreateUser()">Create User</button>
            </div>
        </div>

        <div class="card">
            <h3>Active Passcodes</h3>
            <div style="overflow-x:auto; margin-top:20px;">
                <table style="width:100%; text-align:left; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:1px solid var(--border-color); color:var(--text-muted);">
                            <th style="padding:12px;">User</th>
                            <th style="padding:12px;">Passcode</th>
                            <th style="padding:12px;">Role</th>
                            <th style="padding:12px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5. Storage View -->
    <div id="view-storage" class="view-section">
        <div class="grid-cols-4 mb-8">
            <div class="card stats-card">
                <div class="stat-value" id="storage-disk-percent">0%</div>
                <div class="stat-label">Disk Used</div>
                <i class="fas fa-chart-pie stat-icon"></i>
            </div>
            <div class="card stats-card">
                <div class="stat-value" id="storage-app-total">0MB</div>
                <div class="stat-label">App Data</div>
                <i class="fas fa-folder-open stat-icon"></i>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>Server File Browser</h3>
                <div style="display:flex; gap:12px;">
                    <button class="btn btn-danger" style="background:#fee2e2; border:1px solid #fecaca;"
                        onclick="cleanAllServer()"><i class="fas fa-trash-alt"></i> Clean All</button>
                    <button class="btn btn-secondary" onclick="bulkDeleteFiles()"><i class="fas fa-check-double"></i>
                        Delete Selected</button>
                    <button class="btn btn-secondary" onclick="loadStorageFiles()"><i class="fas fa-sync"></i>
                        Refresh</button>
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%; text-align:left; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:1px solid var(--border-color); color:var(--text-muted);">
                            <th style="padding:12px; width:40px;"><input type="checkbox"
                                    onchange="toggleAllStorage(this)"></th>
                            <th style="padding:12px;">Name</th>
                            <th style="padding:12px;">Folder</th>
                            <th style="padding:12px;">Size</th>
                            <th style="padding:12px;">Date</th>
                            <th style="padding:12px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="storage-files-table">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 4. Job Queue View -->
    <div id="view-jobs" class="view-section">
        <div class="card">
            <h3>Job History</h3>
            <div style="margin-top:24px;">
                <table style="width:100%; text-align:left; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:1px solid var(--border-color); color:var(--text-muted);">
                            <th style="padding:12px;">ID</th>
                            <th style="padding:12px;">Type</th>
                            <th style="padding:12px;">Status</th>
                            <th style="padding:12px;">Created At</th>
                            <th style="padding:12px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="full-jobs-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5. Interactive Browser View -->
    <div id="view-browser" class="view-section">
        <div class="card"
            style="padding:0; overflow:hidden; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.1);">
            <div
                style="background:#f8fafc; padding:12px 20px; border-bottom:1px solid var(--border-color); display:flex; gap:12px; align-items:center;">
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-secondary" style="padding:8px 12px;" onclick="browserBack()"><i
                            class="fas fa-chevron-left"></i></button>
                    <button class="btn btn-secondary" style="padding:8px 12px;" onclick="browserReload()"><i
                            class="fas fa-sync-alt"></i></button>
                </div>
                <input type="text" id="browserUrlInput" class="input-field" style="margin:0; flex:1;"
                    value="https://www.youtube.com" onkeydown="if(event.key==='Enter') navigateBrowser()">
                <div id="browserStatus" style="font-size:0.75rem; color:var(--text-muted);"><i class="fas fa-circle"
                        style="color:#10b981;"></i> Connected</div>
            </div>

            <div id="browserContainer"
                style="position:relative; background:#000; aspect-ratio:16/9; width:100%; cursor:crosshair; overflow:hidden;">
                <img id="browserScreen" style="width:100%; height:100%; object-fit:contain; pointer-events:none;">
                <div id="browserLoadingOverlay"
                    style="position:absolute; inset:0; background:rgba(15,23,42,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; z-index:5;">
                    <i class="fas fa-spinner fa-spin"
                        style="font-size:3rem; margin-bottom:1rem; color:var(--primary);"></i>
                    <div style="font-weight:600; letter-spacing:1px;">INITIALIZING CLOUD BROWSER</div>
                    <div style="font-size:0.8rem; opacity:0.7; margin-top:0.5rem;">Undetected stealth mode active...
                    </div>
                </div>
                <div id="browserInputOverlay" style="position:absolute; inset:0;"
                    onmousemove="handleBrowserMouse(event, 'mousemove')"
                    onmousedown="handleBrowserMouse(event, 'mousedown')"
                    onmouseup="handleBrowserMouse(event, 'mouseup')" onclick="handleBrowserMouse(event, 'click')"
                    onwheel="handleBrowserWheel(event)"></div>
            </div>

            <div
                style="padding:16px 20px; background:#fff; border-top:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; gap:12px; align-items:center;">
                    <label style="font-size:0.8rem; font-weight:600;">Save Download To:</label>
                    <select id="browserTargetProject" class="input-field" style="margin:0; width:180px;"></select>
                    <button class="btn btn-primary" onclick="browserDownloadCurrent()">
                        <i class="fas fa-cloud-download-alt"></i> Import to Project
                    </button>
                </div>
                <div style="color:var(--text-muted); font-size:0.75rem;">
                    <i class="fas fa-info-circle"></i> Remote browser is using undetected stealth mode.
                </div>
            </div>
        </div>
    </div>

</main>

<!-- Sticky Job Monitor -->
<div id="job-monitor-widget" class="job-monitor-sticky" style="display:none;">
    <!-- Hidden by default, show if jobs active -->
    <div class="job-monitor-header">
        <span><i class="fas fa-cog fa-spin"></i> Active Jobs</span>
        <button onclick="document.getElementById('job-monitor-widget').style.display='none'"
            style="background:none; border:none; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div class="job-list" id="active-jobs-list">
        <!-- Live jobs go here -->
    </div>
</div>

<!-- Caption Designer Modal -->
<div id="captionDesignerModal"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:2000; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
    <div
        style="background:#ffffff; color:#1e293b; padding:0; border-radius:24px; width:100%; max-width:800px; display:grid; grid-template-columns: 1fr 1.2fr; overflow:hidden; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);">

        <!-- Preview Side -->
        <div
            style="background:#0f172a; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px; position:relative;">
            <div id="designerPreview"
                style="padding:24px; border-radius:12px; text-align:center; min-height:200px; display:flex; align-items:center; justify-content:center; width:100%;">
                <span id="previewText" style="transition: all 0.2s ease;">PREVIEW TEXT</span>
            </div>
            <div style="margin-top:20px; color:rgba(255,255,255,0.5); font-size:0.75rem;">Real-time Render Preview</div>
        </div>

        <!-- Controls Side -->
        <div style="padding:40px; max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h2 style="font-size:1.5rem; font-weight:700; margin:0;">Typography</h2>
                <button
                    style="border:none; background:#f1f5f9; width:32px; height:32px; border-radius:50%; cursor:pointer;"
                    onclick="closeCaptionDesigner()">✕</button>
            </div>

            <div style="margin-bottom:24px;">
                <label
                    style="font-weight:600; font-size:0.75rem; color:var(--text-muted); display:block; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px;">Trending
                    Presets</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn" style="background:#fbbf24; color:#000; font-weight:700; border-radius:12px;"
                        onclick="applyPreset('hormozi')">Hormozi</button>
                    <button class="btn" style="background:#ef4444; color:#fff; font-weight:700; border-radius:12px;"
                        onclick="applyPreset('beast')">MrBeast</button>
                    <button class="btn" style="background:#000; color:#fff; font-weight:700; border-radius:12px;"
                        onclick="applyPreset('tiktok')">Viral TikTok</button>
                    <button class="btn" style="background:#3b82f6; color:#fff; font-weight:700; border-radius:12px;"
                        onclick="applyPreset('modern')">Clean Modern</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px;">
                <div class="control-group">
                    <label style="display:block; font-size:0.8rem; font-weight:600; margin-bottom:8px;">Font
                        Family</label>
                    <select id="capFontName" class="input-field" style="width:100%; height:44px; border-radius:12px;">
                        <option value="Arial Black">Arial Black</option>
                        <option value="Bebas Neue">Bebas Neue (Strong)</option>
                        <option value="Anton">Anton (Heavy)</option>
                        <option value="Luckiest Guy">Luckiest Guy (Beast)</option>
                        <option value="Bangers">Bangers (TikTok)</option>
                        <option value="Roboto">Roboto Black</option>
                        <option value="Archivo Black">Archivo Black</option>
                        <option value="Oswald">Oswald Bold</option>
                        <option value="Fredoka One">Fredoka One</option>
                        <option value="Titan One">Titan One</option>
                        <option value="Permanent Marker">Handwritten</option>
                    </select>
                </div>
                <div class="control-group">
                    <label style="display:block; font-size:0.8rem; font-weight:600; margin-bottom:8px;">Font
                        Size</label>
                    <input type="number" id="capFontSize" value="24" class="input-field"
                        style="width:100%; height:44px; border-radius:12px;">
                </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px;">
                <div class="control-group">
                    <label style="display:block; font-size:0.8rem; font-weight:600; margin-bottom:8px;">Text
                        Color</label>
                    <input type="color" id="capPrimaryColor" value="#ffffff"
                        style="width:100%; height:44px; padding:4px; border-radius:12px; border:1px solid #e2e8f0; cursor:pointer;">
                </div>
                <div class="control-group">
                    <label style="display:block; font-size:0.8rem; font-weight:600; margin-bottom:8px;">Outline
                        Color</label>
                    <input type="color" id="capOutlineColor" value="#000000"
                        style="width:100%; height:44px; padding:4px; border-radius:12px; border:1px solid #e2e8f0; cursor:pointer;">
                </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px;">
                <div class="control-group">
                    <label style="display:block; font-size:0.8rem; font-weight:600; margin-bottom:8px;">Letter
                        Spacing</label>
                    <input type="range" id="capLetterSpacing" min="-2" max="10" value="0" style="width:100%;">
                </div>
                <div class="control-group">
                    <label style="display:block; font-size:0.8rem; font-weight:600; margin-bottom:8px;">Shadow
                        Intensity</label>
                    <input type="range" id="capShadowBlur" min="0" max="20" value="4" style="width:100%;">
                </div>
            </div>

            <div style="background:#f8fafc; padding:20px; border-radius:16px; margin-bottom:24px;">
                <label style="display:block; font-size:0.8rem; font-weight:600; margin-bottom:12px;">Background
                    Style</label>
                <div style="display:flex; gap:16px; align-items:center; margin-bottom:12px;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="radio" name="borderStyle" value="1" id="styleOutline" checked> Outline
                    </label>
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="radio" name="borderStyle" value="3" id="styleBox"> Background Box
                    </label>
                </div>
                <div id="boxOptions" style="display:none; transition: all 0.3s;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                        <div>
                            <label style="display:block; font-size:0.75rem; margin-bottom:6px;">Box Color</label>
                            <input type="color" id="capBackgroundColor" value="#000000"
                                style="width:100%; height:34px; border-radius:8px;">
                        </div>
                        <div>
                            <label style="display:block; font-size:0.75rem; margin-bottom:6px;">Alignment</label>
                            <select id="capAlignment" class="input-field"
                                style="height:34px; padding:0 8px; font-size:0.8rem;">
                                <option value="2">Bottom</option>
                                <option value="10">Middle</option>
                                <option value="6">Top</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary"
                style="width:100%; height:56px; border-radius:16px; font-weight:700; font-size:1.1rem; box-shadow:0 10px 15px -3px rgba(99,102,241,0.3);"
                onclick="confirmStyledBurn()">
                Burn This Style
            </button>
        </div>
    </div>
</div>

<!-- Download Detected Notification Panel -->
<div id="downloadModal"
    style="display:none; position:fixed; bottom:20px; right:20px; z-index:9000; align-items:flex-end; justify-content:flex-end; pointer-events:none;">
    <div class="card"
        style="width:380px; background:#fff; padding:24px; border-radius:20px; box-shadow:0 20px 50px rgba(0,0,0,0.2); pointer-events:auto; border:1px solid var(--border-color);">
        <div style="display:flex; align-items:flex-start; gap:16px; margin-bottom:16px;">
            <div
                style="width:48px; height:48px; background:#e0e7ff; color:var(--primary); border-radius:12px; display:grid; place-items:center; flex-shrink:0;">
                <i class="fas fa-cloud-download-alt" style="font-size:1.2rem;"></i>
            </div>
            <div style="overflow:hidden;">
                <h2 style="font-size:1.1rem; font-weight:700; color:var(--text-main); margin-bottom:2px;">New Video
                    Detected</h2>
                <div id="detectedFilename"
                    style="font-size:0.85rem; color:var(--primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:600;">
                    file_name_here.mp4</div>
            </div>
        </div>

        <div style="margin-bottom:16px;">
            <label
                style="display:block; font-size:0.75rem; font-weight:600; margin-bottom:6px; color:var(--text-main);">Target
                Project</label>
            <select id="detectTargetProject" class="input-field" style="height:40px; font-size:0.85rem;"></select>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <button class="btn btn-secondary" onclick="closeDownloadModal()"
                style="height:40px; font-size:0.85rem;">Dismiss</button>
            <button class="btn btn-primary" onclick="confirmImportDownload()"
                style="height:40px; font-size:0.85rem;">Import Now</button>
        </div>
    </div>
</div>

<!-- Server Import Modal (Safe Import) -->
<div id="serverImportModal" class="modal"
    style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); z-index:9500; align-items:center; justify-content:center;">
    <div class="card"
        style="width:100%; max-width:600px; background:#fff; padding:32px; border-radius:24px; box-shadow:var(--shadow-lg);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h2 style="font-size:1.4rem; font-weight:700;">Safe Import / File Recovery</h2>
            <button class="btn btn-secondary" onclick="closeServerImportModal()"
                style="padding:4px 12px;">Close</button>
        </div>
        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:16px;">These files were captured but not yet
            imported to a project. Select one to recover it.</p>

        <div style="max-height:350px; overflow-y:auto; border:1px solid var(--border-color); border-radius:12px;">
            <table style="width:100%; text-align:left; border-collapse:collapse;">
                <thead
                    style="background:#f8fafc; font-size:0.75rem; text-transform:uppercase; color:var(--text-muted);">
                    <tr>
                        <th style="padding:12px;">Filename</th>
                        <th style="padding:12px;">Size</th>
                        <th style="padding:12px;">Action</th>
                    </tr>
                </thead>
                <tbody id="server-staged-list">
                    <!-- JS Populated -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="errorMessage"
    style="display:none; position:fixed; top:20px; right:20px; z-index:9999; background:#fee2e2; color:#b91c1c; padding:16px; border-radius:8px; box-shadow:var(--shadow-lg);">
</div>

<!-- Reel View Modal (TikTok Style) -->
<div id="reelModal" class="reel-modal">
    <div class="reel-close" onclick="closeReelView()">✕</div>
    <div class="reel-container">
        <video id="reelVideo" class="reel-video" loop playsinline preload="auto"></video>
        <div class="reel-nav">
            <div class="reel-btn" onclick="prevReel()" title="Previous Clip"><i class="fas fa-chevron-up"></i></div>
            <div class="reel-btn" onclick="nextReel()" title="Next Clip"><i class="fas fa-chevron-down"></i></div>
            <div class="reel-btn" id="reelDownloadBtn" title="Download This Clip"><i class="fas fa-download"></i></div>
        </div>
        <div class="reel-info">
            <div id="reelTitle" class="reel-title">Clip Name</div>
            <div id="reelSubtitle" class="reel-subtitle">Project Name • 0:00</div>
        </div>
        <div id="reelProgress" class="reel-progress"></div>
    </div>
</div>

{% endblock %}